<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!--<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">-->
	<!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>-->
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
	<link
		href="https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&amp;display=swap"
		rel="stylesheet">
	<script src="scripts/jquery-3.5.1.min.js"></script>
	<script src="scripts/jquery.transit.min.js"></script>
	<script src="scripts/jquery-cookie-1.4.1.min.js"></script>
	<script src="scripts/showdown.min.js"></script>

	<script> <!-- global variables -->
		const VERSION = '1.2.8';
		var converter = new showdown.Converter({ emoji: 'true' });
		var bg_menu_toggle = false;
		var default_user_name = "You";
		var name1 = default_user_name;
		var name2 = "Chloe";
		var chat = [{ name: 'Chloe', is_user: false, is_name: true, create_date: 0, mes: '\n*You went inside. The air smelled of fried meat, tobacco and a hint of wine. A dim light was cast by candles, and a fire crackled in the fireplace. It seems to be a very pleasant place. Behind the wooden bar is an elf waitress, she is smiling. Her ears are very pointy, and there is a twinkle in her eye. She wears glasses and a white apron. As soon as she noticed you, she immediately came right up close to you.* "Hello there! How is your evening going?"\n' }];

		var chat_create_date = 0;

		var default_ch_mes = "Hello";
		var count_view_mes = 0;
		var mesStr = '';
		var generatedPromtCache = '';
		var characters = [];
		var this_chid;

		var backgrounds = [];
		var default_avatar = 'img/fluffy.png';
		var is_colab = false;
		var is_checked_colab = false;
		var is_mes_reload_avatar = false;

		var menu_type = '';//what is selected in the menu
		var selected_button = '';//which button pressed
		//create pole save
		var create_save_name = '';
		var create_save_description = '';
		var create_save_personality = '';
		var create_save_first_message = '';
		var create_save_avatar = '';
		var create_save_scenario = '';
		var create_save_mes_example = '';

		var timerSaveEdit;
		var durationSaveEdit = 200;
		//animation right menu
		var animation_rm_duration = 200;
		var animation_rm_easing = "";

		var popup_type = "";
		var bg_file_for_del = '';
		var online_status = 'no_connection';

		var api_server = "";
		//var interval_timer = setInterval(getStatus, 2000);
		var getStatusNovel;
		var interval_timer_novel = setInterval(getStatusNovel, 3000);
		var is_get_status = false;
		var is_get_status_novel = false;
		var is_api_button_press = false;
		var is_api_button_press_novel = false;

		var is_send_press = false;//Send generation
		var add_mes_without_animation = false;

		var this_del_mes = 0;

		var this_edit_mes_text = '';
		var this_edit_mes_chname = '';
		var this_edit_mes_id;

		const delay = ms => new Promise(res => setTimeout(res, ms));
		//settings
		var settings;
		var koboldai_settings;
		var koboldai_setting_names;
		var preset_settings = 'gui';
		var user_avatar = 'you.png';
		var temp = 0.5;
		var amount_gen = 80;				//default max length of AI generated responses
		var max_context = 2048;
		var rep_pen = 1;
		var rep_pen_size = 100;

		var is_pygmalion = false;
		var tokens_already_generated = 0;
		var message_already_generated = '';
		var if_typing_text = false;
		const tokens_cycle_count = 30;
		var cycle_count_generation = 0;

		var anchor_order = 0;
		var style_anchor = true;
		var character_anchor = true;
		var auto_connect;// = false;
		var auto_load_chat;// = false;

		var main_api = 'kobold';
		//novel settings
		var temp_novel = 0.5;
		var rep_pen_novel = 1;
		var rep_pen_size_novel = 100;

		var api_key_novel = "";
		var novel_tier;
		var model_novel = "euterpe-v2";
		var novelai_settings;
		var novelai_setting_names;
		var preset_settings_novel = 'Classic-Krake';

		//css
		var bg1_toggle = true;					// inits the BG as BG1
		var css_mes_bg = $('<div class="mes"></div>').css('background');
		var css_send_form_display = $('<div id=send_form></div>').css('display');

		var colab_ini_step = 1;
	//console.log('finished loading global variables');
	</script>
	<script> <!-- global variables from RossAscends-mods-->
		var safetychat = [{ name: 'Chloe', is_user: false, is_name: true, create_date: 0, mes: '\n*You deleted a charcter and arrived back here for safety reasons! Pick another character!*\n\n' }];
		var active_character;
		var is_advanced_char_open = false;
		var chid;// = active_character;
		var this_chid;// = active_character;
		var stickyNavPref = false;		//defaults panels to not be sticky
		var NavOpenClosePref = false;	//defaults to panel being closed, will remember the open/close state between page loads if user has stickyNavPref enabled.
		var RefreshByDelChar = false;
		var NavToggle = document.getElementById("nav-toggle");
		var PanelPin = document.getElementById("rm_button_panel_pin");
		//console.log('finished loading global vars for RA-mods');
	</script>


	<script type="module" src="TAI-main.js"></script> <!--moved main TAI functions outside HTML-->
	<script type="module" src="scripts/RossAscends-mods.js"></script>
	<link rel="stylesheet" type="text/css" href="style.css">
	<link rel="stylesheet" href="css/bg_load.css">
	<link rel="icon" type="image/x-icon" href="favicon.ico">

	<title>Tavern.AI</title>
</head>

<body>
	<div id="bg1"></div>
	<div id="bg2"></div>
	<div id="top-bar"></div>

	<div id="shadow_popup">
		<div id="dialogue_popup">
			<div id="dialogue_popup_text">
				<h3>text</h3>
			</div>
			<div id="dialogue_popup_ok" class="menu_button">Delete</div>
			<div id="dialogue_popup_cancel" class="menu_button">Cancel</div>
		</div>
	</div>
	<div id="colab_shadow_popup">
		<div id="colab_popup">
			<div id="colab_popup_text" style="float: left;margin-left: 88px;">
				<h3>Initialization</h3>
			</div>
		</div>
	</div>
	<!--<div id="shadow_character_popup">
        </div>-->
	<div id="character_popup">

		<div id="character_popup_text">
			<div>
				<img src="img/book2.png" id="advanced_book_logo">
			</div>

			<div>
				<h3 id="character_popup_text_h3"></h3> - Advanced Defininitions
			</div>

		</div>
		<img id="character_cross" src="img/cross.png"
			style="position: absolute; right: 15px; top: 15px; width: 20px; height: 20px; cursor: pointer; opacity: 0.6">

		<div id="personality_div">
			<hr>
			<h4>Personality summary</h4>
			<h5>A brief description of the personality <a href="/notes/2" class="notes-link" target="_blank"><span
						class="note-link-span">?</span></a></h5>
			<input id="personality_textarea" name="personality" placeholder="" form="form_create" class="text_pole"
				autocomplete="off">
		</div>

		<div id="scenario_div">
			<h4>Scenario</h4>
			<h5>Circumstances and context of the dialogue <a href="/notes/12" class="notes-link" target="_blank"><span
						class="note-link-span">?</span></a></h5>
			<input id="scenario_pole" name="scenario" class="text_pole" maxlength="9999" value="" autocomplete="off"
				form="form_create">
		</div>

		<div id="mes_example_div">
			<div>
				<h4>Examples of dialogue</h4>
				<h5>Forms a personality more clearly <a href="/notes/11" class="notes-link" target="_blank"><span
							class="note-link-span">?</span></a></h5>
			</div>
			<textarea id="mes_example_textarea" name="mes_example" placeholder="" form="form_create"></textarea>
		</div>
		<div id="character_popup_ok" class="menu_button">Save</div>

	</div>
	<div id="shadow_select_chat_popup">
		<div id="select_chat_popup">
			<div id="select_chat_popup_text">
				<img id="select_chat_cross" src="img/cross.png"
					style="position: absolute; right: 15px; top:14px; width: 20px; height: 20px; cursor: pointer; opacity: 0.6">

			</div>
			<div id="select_chat_import"> <!-- import chat popup header -->

				<input id="chat_import_button" class="menu_button" type="submit" value="+Import">
				<div>
					<a href="/notes/10" class="notes-link" target="_blank"><span class="note-link-span">?</span></a>
				</div>
				<form id="form_import_chat" action="javascript:void(null);" method="post" enctype="multipart/form-data"
					style="display: none;">
					<input type="file" id="chat_import_file" accept=".json, .jsonl" name="avatar">
					<input id="chat_import_file_type" name="file_type" class="text_pole" maxlength="999" size="2"
						value="" autocomplete="off" style="display: none;">
					<input id="chat_import_avatar_url" name="avatar_url" class="text_pole" maxlength="999" size="2"
						value="" autocomplete="off" style="display: none;">
					<input id="chat_import_character_name" name="character_name" class="text_pole" maxlength="999"
						size="2" value="" autocomplete="off" style="display: none;">
				</form>
			</div>

			<div id="select_chat_div">

			</div>
			<div id="load_select_chat_div">
				<img src="img/load.svg">
			</div>


		</div>
	</div>
	<div id="shadow_tips_popup">
		<div id="tips_popup">
			<img id="tips_cross" src="img/cross.png"
				style="position: absolute; margin-left: 230px; width: 20px; height: 20px; cursor: pointer; opacity: 0.6">

			<img src="img/love.png" style="width: 45px;height: 45px; margin-bottom: 0px; opacity: 0.6;">
			<div style="margin-top:20px; margin-left: 20px; margin-right: 20px; margin-bottom: 15px;">
				<u>TavernAI</u> is being developed with love and care on a voluntary basis. If you like the project and
				want to support it, your donation would make a huge impact! <u>Thank you!</u>
			</div>
			<img src="img/eth_icon.png" style="width: 35px;height: 35px; margin-bottom: 0px; opacity: 0.6;">
			<img src="img/usdt.png" style="width: 35px;height: 35px; margin-bottom: 0px; opacity: 0.6;">
			<div id="tips_text">
				<h3 style="margin-top: 0px; opacity: 0.8">Ethereum or USDT</h3>
			</div>

			<img src="img/eth.png" style="opacity: 0.4; margin-bottom: 4px;">
			<div>0x975E5C91042ce8168B3d37b17F99949c5eFB3Dfe</div>
			<!--<div style="margin-bottom:5px;">***</div><div>TRX: TCiBKCt6xEGrsjpgQA2jDXWJLyUh1KN2Sn</div><div>BTC: 1LASziomyYNkZ2zk8Sa4ZLTkvczBMrjyjP</div>-->
		</div>
	</div>
	<div id="bg_menu">
		<div id="logo_block">
			<div id="bg_menu_button"><img src="img/tri.png">
			</div>
			<img src="img/logo.png" id="site_logo">
			<div id="update-notification">
				<a id="verson" href="https://github.com/TavernAI/TavernAI" target="_blank"></a>
			</div>
		</div>

		<div id="bg_menu_content">
			<form id="form_bg_download" action="javascript:void(null);" method="post" enctype="multipart/form-data">
				<label class="input-file">
					<input type="file" id="add_bg_button" name="avatar"
						accept="image/png, image/jpeg, image/jpg, image/gif, image/bmp">
					<span class="bg_example_but_load"><img src='img/addbg3.png'></span>

				</label>
			</form>

		</div>
	</div>
	<input type="checkbox" id="nav-toggle">

	<nav id="right-nav-panel">
		<div id="right-nav-panel-tabs">
			<div class="right_menu_button" id="rm_button_characters" title="Select/Create Characters">&#x1F464;</div>
			<div class="right_menu_button" id="rm_button_settings" title="API and AI Settings">⚙️</div>
			<div class="right_menu_button" id="rm_button_selected_ch">
				<h2></h2>
			</div>
			<div class="right_menu_button" id="rm_button_panel_pin_div"><input type="checkbox" id="rm_button_panel_pin"
					title="Locked = Settings panel stays open"></div>
		</div>

		<div id="rm_ch_create_block" class="right_menu" style="display: none;">
			<form id="form_create" action="javascript:void(null);" method="post" enctype="multipart/form-data">
				<div id="avatar-and-name-block">
					<div id="name_div">
						<h4>Character Name</h4><br>
						<input id="character_name_pole" name="ch_name" class="text_pole" maxlength="120" value=""
							autocomplete="off">
					</div>
					<div id="avatar_div" class="avatar_div">
						<div id="avatar_div_div" class="avatar">
							<img id="avatar_load_preview" src="img/fluffy.png" alt="avatar">
						</div>
						<label for="add_avatar_button" class="menu_button"
							title="Click to select a new avatar for this character">
							<input type="file" id="add_avatar_button" name="avatar"
								accept="image/png, image/jpeg, image/jpg, image/gif, image/bmp">
							Change Avatar
						</label>
					</div>
					<div id="result_info" style="width: 100px;">&nbsp;</div>
				</div>
				<hr>
				<div id="description_div" class="margin-bot-10px">
					<h4>Description <a href="/notes/1" class="notes-link" target="_blank"><span
								class="note-link-span">?</span></a></h4>
				</div>
				<textarea id="description_textarea" class="margin-bot-10px" name="description"
					placeholder=""></textarea>

				<div id="first_message_div" class="margin-bot-10px">
					<h4>First message<a href="/notes/3" class="notes-link" target="_blank"><span
								class="note-link-span">?</span></a></h4>
				</div>
				<textarea id="firstmessage_textarea" class="margin-bot-10px" name="first_mes" placeholder=""></textarea>

				<!-- these divs are invisible and used for server communication purposes -->
				<div id="hidden-divs">
					<div id="avatar_url_div">
						<input id="avatar_url_pole" name="avatar_url" class="text_pole" maxlength="999" size="2"
							value="" autocomplete="off">
					</div>
					<div id="selected_chat_div">
						<input id="selected_chat_pole" name="chat" class="text_pole" maxlength="999" size="2" value=""
							autocomplete="off">
					</div>
					<div id="create_date_div">
						<input id="create_date_pole" name="create_date" class="text_pole" maxlength="999" size="2"
							value="" autocomplete="off">
					</div>
					<div id="last_mes_div">
						<input id="last_mes_pole" name="last_mes" class="text_pole" maxlength="999" size="2" value=""
							autocomplete="off">
					</div>
				</div>
				<!-- now back to normal divs for display purposes-->

				<input id="advanced_div" class="menu_button" type="button" value="Advanced Edit">

				<div class="form_create_bottom_buttons_block">
					<div id="rm_button_back" class="menu_button">Go Back</div>
					<input id="delete_button" class="menu_button" type="button" value="Delete">
					<input id="export_button" class="menu_button" type="button" value="Export">
					<input id="create_button" class="menu_button" type="submit" value="Create">

				</div>

			</form>
		</div>
		<div id="rm_api_block" class="right_menu">

			<div id="main-API-selector-block">
				<h3 id="title_api">API</h3>
				<select id="main_api">
					<option value="kobold">KoboldAI</option>
					<option value="novel">NovelAI</option>
				</select>
			</div>

			<div id="respective-settings-block">
				<div id="kobold_api" style="position: relative;"> <!-- shows the kobold settings -->
					<div class="API-logo">
						<a href="https://github.com/KoboldAI/KoboldAI-Client" target="_blank">
							<img src="img/kobold.png" style="width:40px;height:40px;">
						</a>
					</div>
					<form action="javascript:void(null);" method="post" enctype="multipart/form-data">
						<h4>API url</h4>
						<h5>Example: http://127.0.0.1:5000/api </h5>
						<input id="api_url_text" name="api_url" class="text_pole" maxlength="500" value=""
							autocomplete="off">
						<input id="api_button" class="menu_button" type="submit" value="Connect">
						<img id="api_loading" src="img/load.svg">
						<div id="online_status2">
							<div id="online_status_indicator2"></div>
							<div id="online_status_text2">Not connected</div>
						</div>
					</form>

					<hr>

					<div id="ai-presets-and-config-block">
						<h4>Preset settings <a href="/notes/4" class="notes-link" target="_blank"><span
									class="note-link-span">?</span></a></h4>
						<select id="settings_perset">
							<option value="gui">GUI KoboldAI Settings</option>
						</select>
						<div id="range_block">
							<div class="range-block">
								<div class="range-block-title">
									<h4>Temperature </h4>
								</div>
								<div class="range-block-counter">
									<h5 id="temp_counter">select</h5>
								</div>
								<div class="range-block-range"><input type="range" id="temp" name="volume" min="0.1"
										max="2.0" step="0.01"></div>
							</div>
							<div class="range-block">
								<div class="range-block-title">
									<h4>Repetition Penalty </h4>
								</div>
								<div class="range-block-counter">
									<h5 id="rep_pen_counter">select</h5>
								</div>
								<div class="range-block-range"><input type="range" id="rep_pen" name="volume" min="1"
										max="1.5" step="0.01"></div>
							</div>
							<div class="range-block">
								<div class="range-block-title">
									<h4>Repetition Penalty Range</h4>
								</div>
								<div class="range-block-counter">
									<h5 id="rep_pen_size_counter">select</h5>
								</div>
								<div class="range-block-range"><input type="range" id="rep_pen_size" name="volume"
										min="0" max="2048" step="1"></div>
							</div>
						</div>
					</div>
				</div>

				<div id="novel_api" style="display: none;position: relative;"> <!-- shows the novel settings -->
					<div class="API-logo">
						<a href="https://novelai.net/" target="_blank">
							<img src="img/novelai.png" style="width:auto;height:22px;">
						</a>
					</div>
					<form action="javascript:void(null);" method="post" enctype="multipart/form-data">
						<h4>Novel API key<a href="/notes/6" class="notes-link" target="_blank"><span
									class="note-link-span">?</span></a></h4>
						<input id="api_key_novel" name="api_key_novel" class="text_pole" maxlength="500" value=""
							autocomplete="off">
						<Br>
						<input id="api_button_novel" class="menu_button" type="submit" value="Connect">
						<img id="api_loading_novel" src="img/load.svg">
					</form>
					<div id="online_status3">
						<div id="online_status_indicator3"></div>
						<div id="online_status_text3">No connection...</div>
					</div>
					<h4>Novel AI Model<a href="/notes/8" class="notes-link" target="_blank"><span
								class="note-link-span">?</span></a></h4>
					<select id="model_novel_select" class="option_select_right_menu" style='margin-bottom: 16px;'>
						<option value="euterpe-v2">Euterpe</option>
						<option value="krake-v2">Krake</option>
					</select>
					<h4>Preset settings<a href="/notes/7" class="notes-link" target="_blank"><span
								class="note-link-span">?</span></a></h4>
					<select id="settings_perset_novel" class="option_select_right_menu">
						<option value="gui">Default</option>
					</select>
					<div id="range_block_novel">
						<h4>Temperature </h4>
						<h5 id="temp_counter_novel">select</h5>
						<input type="range" id="temp_novel" name="volume" min="0.1" max="2.0" step="0.01">
						<h4>Repetition Penalty </h4>
						<h5 id="rep_pen_counter_novel">select</h5>
						<input type="range" id="rep_pen_novel" name="volume" min="1" max="1.5" step="0.01">
						<h4>Repetition Penalty Range</h4>
						<h5 id="rep_pen_size_counter_novel">select</h5>
						<input type="range" id="rep_pen_size_novel" name="volume" min="0" max="2048" step="1">
					</div>
				</div>
			</div>

			<hr>

			<div id="user-settings-block">
				<h3>User Settings</h3>
				<h4>Your Avatar</h4>
				<div id="user_avatar_block"></div>
				<form id='form_change_name' action="javascript:void(null);" method="post" enctype="multipart/form-data">
					<h4>Name</h4><br>
					<input id="your_name" name="your_name" class="text_pole" maxlength="35" value=""
						autocomplete="off"><br>
					<input id="your_name_button" class="menu_button" type="submit"
						title="Click to set a new User Name (reloads page)" value="Change Name">
				</form>
			</div>

			<hr>

			<div id="pro-settings-block">
				<h3>Pro Settings</h3>
				<div id="amount_gen_block">
					<h4>Amount generation </h4>
					<h5 id="amount_gen_counter">select</h5>
					<input type="range" id="amount_gen" name="volume" min="16" max="512" step="1">
				</div>
				<div id="max_context_block">
					<h4>Context Size</h4>
					<h5 id="max_context_counter">select</h5>
					<input type="range" id="max_context" name="volume" min="512" max="2048" step="1">
				</div>
				<div id="anchors-block">
					<h4>Anchors Order</h4>
					<h5>Helps to increase the length of messages <a href="/notes/9" class="notes-link"
							target="_blank"><span class="note-link-span">?</span></a></h5>
					<select id="anchor_order">
						<option value="0">Character Anchor - Style Anchor</option>
						<option value="1">Style Anchor - Character Anchor</option>
					</select>
					<div id="anchor_checkbox">
						<input id="character_anchor" type="checkbox" />
						<h4>Character Anchor</h4>
						<input id="style_anchor" type="checkbox" />
						<h4>Style Anchor</h4>
					</div>
				</div>
			</div>

			<hr>

			<div="power-user-options-block">
				<h3>Power User Options</h3>
				<div id="power-user-option-checkboxes">
					<input id="auto-connect-checkbox" type="checkbox" />
					<h4>Auto-connects Last Server</h4>
					<input id="auto-load-chat-checkbox" type="checkbox" />
					<h4>Auto-load Last Chat</h4>
				</div>
			</div>

		</div>

		<div id="rm_character_import" class="right_menu" style="display: none;">
			<form id="form_import" action="javascript:void(null);" method="post" enctype="multipart/form-data">
				<input type="file" id="character_import_file" accept=".json, image/png" name="avatar">
				<input id="character_import_file_type" name="file_type" class="text_pole" maxlength="999" size="2"
					value="" autocomplete="off">
			</form>
		</div>


		<div id="rm_characters_block" class="right_menu">
			<div class="form_create_bottom_buttons_block">
				<div id="rm_button_create" class="menu_button">+New Character</div>
				<div id="character_import_button" class="menu_button">+Import Character</div>
				<div id="characloud_url" class="menu_button" title="Find more characters on CharaCloud (coming soon)">
					<img src="img/cloud_logo.png">
				</div>
			</div>
			<div id="rm_print_characters_block"></div>

		</div>
		<div id="rm_info_block" class="right_menu">
			<div id="rm_info_panel">
				<div id="rm_info_avatar"></div>
				<div id="rm_info_text"></div>
				<div id="rm_info_button" class="menu_button">Back</div>
			</div>
		</div>
	</nav>
	<div id="sheld">
		<div id="chat"></div>
		<div id="form_sheld">
			<div id="dialogue_del_mes">
				<div id="dialogue_del_mes_ok" class="menu_button">Delete</div>
				<div id="dialogue_del_mes_cancel" class="menu_button">Cancel</div>
			</div>
			<form id="send_form">
				<div id="options_button">
					<div id="options">
						<div class="options-content">
							<a id="option_start_new_chat"><img src="img/save_and_start_new_chat.png"><span>Start new
									chat</span></a>
							<a id="option_select_chat"><img src="img/book6.png"><span>View Past Chats</span></a>
							<hr>
							<a id="option_delete_mes"><img src="img/del_mes.png"><span>Delete messages</span></a>
							<a id="option_regenerate"><img src="img/regenerate.png"><span>Regenerate</span></a>
						</div>
					</div>
				</div>
				<textarea id="send_textarea" placeholder="Not connected to API!" name="text"></textarea>


				<script type="text/javascript">
					//RossAscends: this script makes the chat input text area resize vertically to match the text size (limited by CSS at 50% window height)	
					$('#send_textarea').on('input', function () {
						this.style.height = '40px';
						this.style.height =
							(this.scrollHeight) + 'px';
					});
				</script>

				<div id="send_but_sheld">
					<div id="loading_mes"></div>
					<input id="send_but" type="button">
				</div>

			</form>
		</div>
	</div>



</body>

</html>